version: 1
frontend:
  phases:
    preBuild:
      commands:
        - npm ci --cache .npm --prefer-offline
        - |
          set -e
          rm -f .env.production
          {
            echo "MONGO_URI=$MONGO_URI"
            echo "HASH_SECRET=$HASH_SECRET"
            echo "ENC_KEY=$ENC_KEY"
            echo "DISABLE_AUTH=$DISABLE_AUTH"
            echo "AUTH_COOKIE_NAME=$AUTH_COOKIE_NAME"
            echo "AUTH_COOKIE_DOMAIN=$AUTH_COOKIE_DOMAIN"
            echo "NEXTAUTH_URL=$NEXTAUTH_URL"
            echo "NEXTAUTH_SECRET=$NEXTAUTH_SECRET"
            echo "NEXT_PUBLIC_ALLOWED_CALLBACK_HOSTS=$NEXT_PUBLIC_ALLOWED_CALLBACK_HOSTS"
            echo "AZURE_AD_CLIENT_ID=$AZURE_AD_CLIENT_ID"
            echo "AZURE_AD_CLIENT_SECRET=$AZURE_AD_CLIENT_SECRET"
            echo "AZURE_AD_TENANT_ID=$AZURE_AD_TENANT_ID"
            echo "_AWS_BUCKET_NAME=$_AWS_BUCKET_NAME"
            echo "_AWS_REGION=$_AWS_REGION"
            echo "_AWS_ACCESS_KEY_ID=$_AWS_ACCESS_KEY_ID"
            echo "_AWS_SECRET_ACCESS_KEY=$_AWS_SECRET_ACCESS_KEY"
            echo "SAFETY_EMAIL=$SAFETY_EMAIL"
            echo "NO_REPLY_EMAIL=$NO_REPLY_EMAIL"
            echo "NEXT_PUBLIC_TURNSTILE_SITE_KEY=$NEXT_PUBLIC_TURNSTILE_SITE_KEY"
            echo "TURNSTILE_SECRET_KEY=$TURNSTILE_SECRET_KEY"
            echo "CRON_SECRET=$CRON_SECRET"
            echo "NEXT_IMAGE_DOMAINS=$NEXT_IMAGE_DOMAINS"
            echo "NEXT_PUBLIC_PORTAL_BASE_URL=$NEXT_PUBLIC_PORTAL_BASE_URL"
            echo "NODE_ENV=production"
          } >> .env.production
          # Also write a copy as .env for any tooling that reads it
          cp .env.production .env
    build:
      commands:
        - npm run build
  artifacts:
    baseDirectory: .next
    files:
      - "**/*"
  cache:
    paths:
      - .next/cache/**/*
      - .npm/**/*
